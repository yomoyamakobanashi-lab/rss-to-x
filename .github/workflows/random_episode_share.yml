name: Random Episode Share

on:
  schedule:
    - cron: '0 1 * * *'   # æ¯æ—¥1å›ï¼ˆUTC 1æ™‚ = JST 10æ™‚ï¼‰
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # episodes.txt ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰é¸ã¶
      - name: Pick random episode
        id: pick
        run: |
          # ğŸ§ ãŒä»˜ã„ã¦ã„ã‚‹è¡Œæ•°ã‚’æ•°ãˆã‚‹ï¼ˆ= ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°ï¼‰
          TOTAL=$(grep -n "^ğŸ§" episodes.txt | wc -l)

          if [ "$TOTAL" -eq 0 ]; then
            echo "No episodes found"
            exit 1
          fi

          # ãƒ©ãƒ³ãƒ€ãƒ ã§1ã¤é¸ã¶
          INDEX=$((RANDOM % TOTAL + 1))

          # ã‚¿ã‚¤ãƒˆãƒ«è¡Œ
          TITLE_LINE=$(grep -n "^ğŸ§" episodes.txt | sed -n "${INDEX}p")
          TITLE=$(echo "$TITLE_LINE" | cut -d: -f2-)

          # ãƒªãƒ³ã‚¯è¡Œï¼ˆã‚¿ã‚¤ãƒˆãƒ«è¡Œã®æ¬¡ã®è¡Œï¼‰
          LINE_NO=$(echo "$TITLE_LINE" | cut -d: -f1)
          LINK=$(sed -n "$((LINE_NO + 1))p" episodes.txt)

          # GitHub Actions ã® output ã«æ¸¡ã™ï¼ˆè¤‡æ•°è¡ŒOKï¼‰
          {
            echo "text<<EOF"
            echo "$TITLE"
            echo "$LINK"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # Twitter API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm install twitter-api-v2

      # X ã«æŠ•ç¨¿ï¼ˆOAuth 1.0aï¼‰
      - name: Post to X
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          EPISODE_TEXT: ${{ steps.pick.outputs.text }}
        run: |
          node << 'EOF'
          const { TwitterApi } = require('twitter-api-v2');

          const client = new TwitterApi({
            appKey: process.env.X_API_KEY,
            appSecret: process.env.X_API_SECRET,
            accessToken: process.env.X_ACCESS_TOKEN,
            accessSecret: process.env.X_ACCESS_SECRET,
          });

          const text = `éå»å›ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ğŸ¬
${process.env.EPISODE_TEXT}

#ãƒªãƒ«ãƒ‘ãƒ«`;

          (async () => {
            await client.v2.tweet(text);
            console.log('Random episode posted');
          })();
          EOF
