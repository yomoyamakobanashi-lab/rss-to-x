name: Random Episode Share

on:
  schedule:
    # æ—¥æœ¬æ™‚é–“ 9:00 / 15:00 / 21:00
    - cron: '0 0 * * *'
    - cron: '0 6 * * *'
    - cron: '0 12 * * *'
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # ä¾å­˜é–¢ä¿‚ã‚’å®‰å…¨ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          npm install twitter-api-v2 node-fetch@2 xml2js jq

      # RSS ã‹ã‚‰ Spotifyç›´ãƒªãƒ³ã‚¯ä¸€è¦§ã‚’ç”Ÿæˆ
      - name: Build episodes from RSS
        run: |
          node scripts/buildEpisodesFromRSS.js

      # ãƒ©ãƒ³ãƒ€ãƒ ã§æ–‡è¨€ã¨ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰URLã‚’é¸æŠ
      - name: Pick random phrase and episode
        id: pick
        run: |
          mkdir -p data

          # phrases.txt ãŒç„¡ã‘ã‚Œã°è‡ªå‹•ç”Ÿæˆï¼ˆä¿é™ºï¼‰
          if [ ! -f data/phrases.txt ]; then
            cat << 'EOF' > data/phrases.txt
ä»Šæ—¥ã¯ã“ã®å›ã‚’ã©ã†ãğŸ¬
éå»å›ã‹ã‚‰ä¸€æœ¬ğŸ§
ã“ã®å›ã€ä»Šè´ãã¨åˆºã•ã‚‹ã‹ã‚‚
ã‚ã‚‰ãŸã‚ã¦ãŠã™ã™ã‚ã—ãŸã„ä¸€æœ¬
ã¡ã‚‡ã£ã¨æ™‚é–“ã‚ã‚‹ãªã‚‰ã“ã®å›
ä»Šæ—¥ã¯ã“ã‚Œã‚’æµã—ã¦ã¿ã¦ã»ã—ã„
å¿˜ã‚ŒãŸé ƒã«ã“ã®å›
éå»å›ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ğŸ¬
æ°—åˆ†ã«åˆã„ãã†ãªå›
ãƒ©ã‚¸ã‚ªæ„Ÿè¦šã§ã©ã†ã
EOF
          fi

          PHRASE=$(shuf -n 1 data/phrases.txt)
          EPISODE=$(jq -r '.[]' data/episodes.json | shuf -n 1)

          echo "phrase=$PHRASE" >> "$GITHUB_OUTPUT"
          echo "episode=$EPISODE" >> "$GITHUB_OUTPUT"

      # X ã«æŠ•ç¨¿ï¼ˆURLæ¬ è½ã—ãªã„å®‰å…¨æ§‹æˆï¼‰
      - name: Post to X
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          PHRASE: ${{ steps.pick.outputs.phrase }}
          EPISODE: ${{ steps.pick.outputs.episode }}
        run: |
          echo "const { TwitterApi } = require('twitter-api-v2');" > post.js
          echo "const client = new TwitterApi({" >> post.js
          echo "  appKey: process.env.X_API_KEY," >> post.js
          echo "  appSecret: process.env.X_API_SECRET," >> post.js
          echo "  accessToken: process.env.X_ACCESS_TOKEN," >> post.js
          echo "  accessSecret: process.env.X_ACCESS_SECRET," >> post.js
          echo "});" >> post.js
          echo "" >> post.js
          echo "const text = \`${process.env.PHRASE}" >> post.js
          echo "${process.env.EPISODE}" >> post.js
          echo "#ãƒªãƒ«ãƒ‘ãƒ«\`;" >> post.js
          echo "" >> post.js
          echo "(async () => {" >> post.js
          echo "  await client.v2.tweet(text);" >> post.js
          echo "  console.log('posted');" >> post.js
          echo "})();" >> post.js
          node post.js
