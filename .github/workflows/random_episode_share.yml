name: Random Episode Share

on:
  schedule:
    # JST 09:00 / 15:00 / 21:00 ï¼ UTC 00:00 / 06:00 / 12:00
    - cron: "0 0 * * *"
    - cron: "0 6 * * *"
    - cron: "0 12 * * *"
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install twitter-api-v2 node-fetch@2 xml2js

      - name: Build episodes from RSS
        run: |
          node scripts/buildEpisodesFromRSS.js

      - name: Pick random phrase and episode
        id: pick
        run: |
          node -e "
          const fs = require('fs');

          // Ensure data dir
          if (!fs.existsSync('data')) fs.mkdirSync('data');

          // Ensure phrases.txt exists (failsafe)
          const phrasesPath = 'data/phrases.txt';
          if (!fs.existsSync(phrasesPath)) {
            const defaults = [
              'ä»Šæ—¥ã¯ã“ã®å›žã‚’ã©ã†ãžðŸŽ¬',
              'éŽåŽ»å›žã‹ã‚‰ä¸€æœ¬ðŸŽ§',
              'ã“ã®å›žã€ä»Šè´ãã¨åˆºã•ã‚‹ã‹ã‚‚',
              'ã‚ã‚‰ãŸã‚ã¦ãŠã™ã™ã‚ã—ãŸã„ä¸€æœ¬',
              'ã¡ã‚‡ã£ã¨æ™‚é–“ã‚ã‚‹ãªã‚‰ã“ã®å›ž',
              'ä»Šæ—¥ã¯ã“ã‚Œã‚’æµã—ã¦ã¿ã¦ã»ã—ã„',
              'å¿˜ã‚ŒãŸé ƒã«ã“ã®å›ž',
              'éŽåŽ»å›žãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ðŸŽ¬',
              'æ°—åˆ†ã«åˆã„ãã†ãªå›ž',
              'ãƒ©ã‚¸ã‚ªæ„Ÿè¦šã§ã©ã†ãž'
            ];
            fs.writeFileSync(phrasesPath, defaults.join('\\n'), 'utf8');
          }

          // Read phrases
          const phrases = fs.readFileSync(phrasesPath, 'utf8')
            .split(/\\r?\\n/)
            .map(s => s.trim())
            .filter(Boolean);

          // Read episodes
          const episodesPath = 'data/episodes.json';
          if (!fs.existsSync(episodesPath)) {
            console.error('Missing data/episodes.json. Build step may have failed.');
            process.exit(1);
          }
          const episodes = JSON.parse(fs.readFileSync(episodesPath, 'utf8'));

          if (!Array.isArray(episodes) || episodes.length === 0) {
            console.error('No episodes found in data/episodes.json');
            process.exit(1);
          }

          // Pick
          const phrase = phrases[Math.floor(Math.random() * phrases.length)];
          const episode = episodes[Math.floor(Math.random() * episodes.length)];

          // Output for GitHub Actions
          const out = process.env.GITHUB_OUTPUT;
          fs.appendFileSync(out, `phrase=${phrase.replace(/\\r?\\n/g, ' ')}\\n`, 'utf8');
          fs.appendFileSync(out, `episode=${episode}\\n`, 'utf8');
          "

      - name: Post to X
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          PHRASE: ${{ steps.pick.outputs.phrase }}
          EPISODE: ${{ steps.pick.outputs.episode }}
        run: |
          node -e "
          const { TwitterApi } = require('twitter-api-v2');

          const client = new TwitterApi({
            appKey: process.env.X_API_KEY,
            appSecret: process.env.X_API_SECRET,
            accessToken: process.env.X_ACCESS_TOKEN,
            accessSecret: process.env.X_ACCESS_SECRET,
          });

          // X shortens links; keep it safely under 140 by design
          const text = `${process.env.PHRASE}\\n${process.env.EPISODE}\\n#ãƒªãƒ«ãƒ‘ãƒ«`;

          (async () => {
            await client.v2.tweet(text);
            console.log('posted');
          })();
          "
