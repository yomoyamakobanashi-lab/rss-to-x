name: Random Episode Share

on:
  schedule:
    # 1日3回（JST 9:00 / 15:00 / 21:00）
    - cron: '0 0 * * *'
    - cron: '0 6 * * *'
    - cron: '0 12 * * *'
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # 依存関係をまとめて安全にインストール
      - name: Install dependencies
        run: |
          npm install twitter-api-v2 node-fetch@2 xml2js jq

      # RSS → Spotify直リンク生成
      - name: Build episodes from RSS
        run: |
          node scripts/buildEpisodesFromRSS.js

      # エピソード＆文言をランダム選択
      - name: Pick random episode & phrase
        id: pick
        run: |
          EP=$(jq -r '.[]' data/episodes.json | shuf -n 1)
          PH=$(shuf -n 1 data/phrases.txt)

          {
            echo "text<<EOF"
            echo "$PH"
            echo "$EP"
            echo "#リルパル"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # Xへ投稿（短文・安全構成）
      - name: Post to X
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          POST_TEXT: ${{ steps.pick.outputs.text }}
        run: |
          echo "const { TwitterApi } = require('twitter-api-v2');" > post.js
          echo "const client = new TwitterApi({" >> post.js
          echo "  appKey: process.env.X_API_KEY," >> post.js
          echo "  appSecret: process.env.X_API_SECRET," >> post.js
          echo "  accessToken: process.env.X_ACCESS_TOKEN," >> post.js
          echo "  accessSecret: process.env.X_ACCESS_SECRET," >> post.js
          echo "});" >> post.js
          echo "" >> post.js
          echo "const text = process.env.POST_TEXT;" >> post.js
          echo "(async () => { await client.v2.tweet(text); console.log('posted'); })();" >> post.js
          node post.js
