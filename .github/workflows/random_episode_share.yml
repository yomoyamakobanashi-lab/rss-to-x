name: Random Episode Share

on:
  schedule:
    # JST 9:00 / 15:00 / 21:00
    - cron: "0 0 * * *"
    - cron: "0 6 * * *"
    - cron: "0 12 * * *"
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install twitter-api-v2 node-fetch@2 xml2js

      - name: Build episodes from RSS
        run: |
          node scripts/buildEpisodesFromRSS.js

      - name: Prepare random post data
        run: |
          mkdir -p data

          # phrases.txt ãŒãªã‘ã‚Œã°ä½œã‚‹ï¼ˆä¿é™ºï¼‰
          if [ ! -f data/phrases.txt ]; then
            cat << 'EOF' > data/phrases.txt
ä»Šæ—¥ã¯ã“ã®å›ã‚’ã©ã†ãğŸ¬
éå»å›ã‹ã‚‰ä¸€æœ¬ğŸ§
ã“ã®å›ã€ä»Šè´ãã¨åˆºã•ã‚‹ã‹ã‚‚
ã‚ã‚‰ãŸã‚ã¦ãŠã™ã™ã‚ã—ãŸã„ä¸€æœ¬
ã¡ã‚‡ã£ã¨æ™‚é–“ã‚ã‚‹ãªã‚‰ã“ã®å›
ä»Šæ—¥ã¯ã“ã‚Œã‚’æµã—ã¦ã¿ã¦ã»ã—ã„
å¿˜ã‚ŒãŸé ƒã«ã“ã®å›
éå»å›ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ğŸ¬
æ°—åˆ†ã«åˆã„ãã†ãªå›
ãƒ©ã‚¸ã‚ªæ„Ÿè¦šã§ã©ã†ã
EOF
          fi

          # Nodeã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆï¼ˆbashã¨åˆ†é›¢ï¼‰
          cat << 'EOF' > makePost.js
          const fs = require('fs');

          const phrases = fs.readFileSync('data/phrases.txt', 'utf8')
            .split(/\\r?\\n/)
            .map(s => s.trim())
            .filter(Boolean);

          const episodes = JSON.parse(fs.readFileSync('data/episodes.json', 'utf8'));

          const phrase = phrases[Math.floor(Math.random() * phrases.length)];
          const episode = episodes[Math.floor(Math.random() * episodes.length)];

          const text = `${phrase}\n${episode}\n#ãƒªãƒ«ãƒ‘ãƒ«`;

          fs.writeFileSync('post.txt', text, 'utf8');
          EOF

          node makePost.js

      - name: Post to X
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        run: |
          cat << 'EOF' > postToX.js
          const fs = require('fs');
          const { TwitterApi } = require('twitter-api-v2');

          const client = new TwitterApi({
            appKey: process.env.X_API_KEY,
            appSecret: process.env.X_API_SECRET,
            accessToken: process.env.X_ACCESS_TOKEN,
            accessSecret: process.env.X_ACCESS_SECRET,
          });

          const text = fs.readFileSync('post.txt', 'utf8');

          (async () => {
            await client.v2.tweet(text);
            console.log('posted');
          })();
          EOF

          node postToX.js
