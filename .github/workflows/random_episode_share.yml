name: Random Episode Share

on:
  schedule:
    - cron: '0 1 * * *'   # æ¯Žæ—¥1å›žï¼ˆUTC 1æ™‚ = JST 10æ™‚ï¼‰
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # episodes.txt ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰é¸ã¶
      - name: Pick random episode
        id: pick
        run: |
          TOTAL=$(grep -n "^ðŸŽ§" episodes.txt | wc -l)
          if [ "$TOTAL" -eq 0 ]; then
            echo "No episodes found"
            exit 1
          fi

          INDEX=$((RANDOM % TOTAL + 1))
          TITLE_LINE=$(grep -n "^ðŸŽ§" episodes.txt | sed -n "${INDEX}p")
          LINE_NO=$(echo "$TITLE_LINE" | cut -d: -f1)
          LINK=$(sed -n "$((LINE_NO + 1))p" episodes.txt)

          echo "link=$LINK" >> "$GITHUB_OUTPUT"

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install twitter-api-v2

      # X ã«æŠ•ç¨¿ï¼ˆçŸ­æ–‡ãƒ»å®‰å…¨æ§‹æˆï¼‰
      - name: Post to X
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          EPISODE_LINK: ${{ steps.pick.outputs.link }}
        run: |
          echo "const { TwitterApi } = require('twitter-api-v2');" > post.js
          echo "const client = new TwitterApi({" >> post.js
          echo "  appKey: process.env.X_API_KEY," >> post.js
          echo "  appSecret: process.env.X_API_SECRET," >> post.js
          echo "  accessToken: process.env.X_ACCESS_TOKEN," >> post.js
          echo "  accessSecret: process.env.X_ACCESS_SECRET," >> post.js
          echo "});" >> post.js
          echo "" >> post.js
          echo "const text = \`ä»Šæ—¥ã¯ã“ã®å›žã‚’ã‚‚ã†ä¸€åº¦ðŸŽ¬" >> post.js
          echo "\${process.env.EPISODE_LINK}" >> post.js
          echo "#ãƒªãƒ«ãƒ‘ãƒ«\`;" >> post.js
          echo "" >> post.js
          echo "(async () => {" >> post.js
          echo "  await client.v2.tweet(text);" >> post.js
          echo "  console.log('Random episode posted');" >> post.js
          echo "})();" >> post.js
          node post.js
