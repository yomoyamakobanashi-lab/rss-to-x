name: Get X OAuth2 Token (no Python)

on:
  workflow_dispatch:
    inputs:
      redirect_full_url:
        description: "STEP2: paste FULL https://127.0.0.1/callback?... URL after approving on X"
        required: false
        default: ""
      code_verifier:
        description: "STEP2: paste the code_verifier printed in STEP1 logs"
        required: false
        default: ""

jobs:
  get:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: STEP1 - Print authorize URL
        if: ${{ github.event.inputs.redirect_full_url == '' }}
        env:
          CLIENT_ID: ${{ secrets.X_CLIENT_ID }}
        shell: bash
        run: |
          set -e
          if [ -z "$CLIENT_ID" ]; then
            echo "‚ùå Missing secret: X_CLIENT_ID"
            exit 1
          fi

          REDIRECT_URI="https://127.0.0.1/callback"
          # PKCE (pure bash/openssl)
          CODE_VERIFIER="$(openssl rand -base64 64 | tr '+/' '-_' | tr -d '=' | cut -c1-86)"
          CODE_CHALLENGE="$(printf '%s' "$CODE_VERIFIER" | openssl dgst -sha256 -binary | openssl base64 | tr '+/' '-_' | tr -d '=')"
          SCOPE_ENC="tweet.read%20tweet.write%20users.read%20offline.access"

          AUTH_URL="https://twitter.com/i/oauth2/authorize?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&scope=${SCOPE_ENC}&state=xyz&code_challenge=${CODE_CHALLENGE}&code_challenge_method=S256"

          echo
          echo "üîó Authorize URL ‚Äî open this and approve with @_macobana:"
          echo "$AUTH_URL"
          echo
          echo "üìå code_verifier (copy this EXACTLY for STEP2 input):"
          echo "$CODE_VERIFIER"
          echo
          echo "‚úÖ After approving, copy the FULL redirect URL from the browser (starts with https://127.0.0.1/callback?...)."
          echo "‚û°Ô∏è Re-run this workflow with inputs:"
          echo "   redirect_full_url = (that full URL)"
          echo "   code_verifier     = (the string above)"

      - name: STEP2 - Exchange code for access token
        if: ${{ github.event.inputs.redirect_full_url != '' && github.event.inputs.code_verifier != '' }}
        env:
          CLIENT_ID: ${{ secrets.X_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.X_CLIENT_SECRET }}
          REDIRECT_FULL: ${{ github.event.inputs.redirect_full_url }}
          CODE_VERIFIER_IN: ${{ github.event.inputs.code_verifier }}
        shell: bash
        run: |
          set -e
          if [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ]; then
            echo "‚ùå Missing secrets: X_CLIENT_ID / X_CLIENT_SECRET"
            exit 1
          fi

          # Extract ?code=... from the pasted URL (pure sed)
          CODE="$(printf '%s\n' "$REDIRECT_FULL" | sed -n 's/.*[?&]code=\([^&]*\).*/\1/p')"
          if [ -z "$CODE" ]; then
            echo "‚ùå Could not parse 'code' from redirect_full_url. Paste the FULL URL."
            exit 1
          fi

          REDIRECT_URI="https://127.0.0.1/callback"

          RESP="$(curl -sS -X POST 'https://api.x.com/2/oauth2/token' \
            -u "${CLIENT_ID}:${CLIENT_SECRET}" \
            -d "grant_type=authorization_code" \
            -d "client_id=${CLIENT_ID}" \
            -d "redirect_uri=${REDIRECT_URI}" \
            -d "code_verifier=${CODE_VERIFIER_IN}" \
            -d "code=${CODE}")"

          echo "[response] $RESP"
          ACCESS="$(printf '%s' "$RESP" | jq -r '.access_token // empty')"
          if [ -z "$ACCESS" ] || [ "$ACCESS" = "null" ]; then
            echo "‚ùå No access_token in response. Check User authentication settings & Callback URL."
            exit 1
          fi

          echo
          echo "================= ACCESS TOKEN ================="
          echo "$ACCESS"
          echo "================================================"
          echo
          echo "Save this in GitHub Secrets as:"
          echo "  Name: X_BEARER_TOKEN"
          echo "  Value: (paste the token above)"
