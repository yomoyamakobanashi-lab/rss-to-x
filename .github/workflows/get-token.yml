name: Get X OAuth2 Token

on:
  workflow_dispatch:
    inputs:
      redirect_full_url:
        description: "STEP2: paste the full redirect URL after approving on X"
        required: false
        default: ""
      code_verifier:
        description: "STEP2: paste the code_verifier printed in STEP1 logs"
        required: false
        default: ""

jobs:
  get:
    runs-on: ubuntu-latest
    steps:
      - name: STEP1 - Print authorize URL
        if: ${{ github.event.inputs.redirect_full_url == '' }}
        env:
          CLIENT_ID: ${{ secrets.X_CLIENT_ID }}
        run: |
          set -e
          if [ -z "$CLIENT_ID" ]; then
            echo "X_CLIENT_ID secret is missing. Add it in Settings → Secrets → Actions."
            exit 1
          fi

          REDIRECT_URI="https://127.0.0.1/callback"

          # PKCE (all one-liners; no heredoc)
          CODE_VERIFIER=$(python3 -c "import os,base64;print(base64.urlsafe_b64encode(os.urandom(40)).rstrip(b'=').decode())")
          export CODE_VERIFIER
          CODE_CHALLENGE=$(python3 -c "import os,hashlib,base64;cv=os.environ['CODE_VERIFIER'];print(base64.urlsafe_b64encode(hashlib.sha256(cv.encode()).digest()).rstrip(b'=').decode())")
          SCOPE_ENC=$(python3 -c "import urllib.parse;print(urllib.parse.quote('tweet.read tweet.write users.read offline.access'))")

          AUTH_URL="https://twitter.com/i/oauth2/authorize?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&scope=${SCOPE_ENC}&state=xyz&code_challenge=${CODE_CHALLENGE}&code_challenge_method=S256"

          echo
          echo "Authorize URL (open this and approve with @_macobana):"
          echo "${AUTH_URL}"
          echo
          echo "code_verifier (copy this for STEP2 input):"
          echo "${CODE_VERIFIER}"
          echo
          echo "Then re-run this workflow with inputs:"
          echo "  - redirect_full_url: full https://127.0.0.1/callback?... URL from the browser"
          echo "  - code_verifier: the string printed above"

      - name: STEP2 - Exchange code for access token
        if: ${{ github.event.inputs.redirect_full_url != '' && github.event.inputs.code_verifier != '' }}
        env:
          CLIENT_ID: ${{ secrets.X_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.X_CLIENT_SECRET }}
          REDIRECT_FULL: ${{ github.event.inputs.redirect_full_url }}
          CODE_VERIFIER_IN: ${{ github.event.inputs.code_verifier }}
        run: |
          set -e
          if [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ]; then
            echo "X_CLIENT_ID / X_CLIENT_SECRET secrets are missing."
            exit 1
          fi

          # parse ?code=... from the pasted URL (no heredoc)
          CODE=$(python3 -c "import os,urllib.parse; u=os.environ['REDIRECT_FULL']; qs=urllib.parse.urlparse(u).query; print(urllib.parse.parse_qs(qs).get('code',[''])[0])")
          if [ -z "$CODE" ]; then
            echo "Could not parse 'code' from the redirect URL. Paste the full URL."
            exit 1
          fi

          REDIRECT_URI="https://127.0.0.1/callback"

          RESP=$(curl -sS -X POST "https://api.x.com/2/oauth2/token" \
            -u "${CLIENT_ID}:${CLIENT_SECRET}" \
            -d "grant_type=authorization_code" \
            -d "client_id=${CLIENT_ID}" \
            -d "redirect_uri=${REDIRECT_URI}" \
            -d "code_verifier=${CODE_VERIFIER_IN}" \
            -d "code=${CODE}")

          echo "[response] $RESP"

          ACCESS=$(python3 -c "import os,json; j=json.loads(os.environ['RESP']); print(j.get('access_token',''))")
          if [ -z "$ACCESS" ]; then
            echo "No access_token in response. Check User authentication settings and Callback URL."
            exit 1
          fi

          echo
          echo "================= ACCESS TOKEN ================="
          echo "$ACCESS"
          echo "================================================"
          echo
          echo "Save this in GitHub Secrets as:"
          echo "  Name: X_BEARER_TOKEN"
          echo "  Value: (paste the token above)"
