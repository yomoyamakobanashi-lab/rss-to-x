name: Get X OAuth2 User Token (no terminal)

on:
  workflow_dispatch:
    inputs:
      redirect_full_url:
        description: "STEP2: Xã§è¨±å¯å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹æ¬„ã«å‡ºãŸURLã‚’ä¸¸ã”ã¨è²¼ã‚Šä»˜ã‘"
        required: false
        default: ""
      code_verifier:
        description: "STEP2: STEP1ã§è¡¨ç¤ºã•ã‚ŒãŸ code_verifier ã‚’è²¼ã‚Šä»˜ã‘"
        required: false
        default: ""

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: STEP1: èªå¯URLã‚’ä½œã‚‹ï¼ˆã¾ãšã¯ã“ã‚Œã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦è¨±å¯ï¼‰
        if: ${{ !inputs.redirect_full_url }}
        env:
          CLIENT_ID: ${{ secrets.X_CLIENT_ID }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${CLIENT_ID:-}" ]; then
            echo "âŒ X_CLIENT_ID ãŒæœªè¨­å®šã§ã™ã€‚Settings â†’ Secrets â†’ Actions ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi

          REDIRECT_URI="https://127.0.0.1/callback"
          SCOPES="tweet.read tweet.write users.read offline.access"

          # PKCE ç”Ÿæˆï¼ˆcode_verifier ã¨ code_challenge ã‚’å‡ºåŠ›ï¼‰
          CODE_VERIFIER=$(python3 -c 'import os,base64;print(base64.urlsafe_b64encode(os.urandom(40)).rstrip(b"=").decode())')
          CODE_CHALLENGE=$(python3 - <<'PY'
import os,hashlib,base64
cv=os.environ["CODE_VERIFIER"]
print(base64.urlsafe_b64encode(hashlib.sha256(cv.encode()).digest()).rstrip(b"=").decode())
PY
)
          echo "code_verifier=${CODE_VERIFIER}" >> $GITHUB_ENV

          # URL ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ã‚¹ã‚³ãƒ¼ãƒ—
          SCOPE_ENC=$(python3 -c 'import urllib.parse; print(urllib.parse.quote("tweet.read tweet.write users.read offline.access"))')

          AUTH_URL="https://twitter.com/i/oauth2/authorize?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&scope=${SCOPE_ENC}&state=xyz&code_challenge=${CODE_CHALLENGE}&code_challenge_method=S256"

          echo ""
          echo "ğŸ”— ä¸‹ã®URLã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã€@_macobana ã§è¨±å¯ã—ã¦ãã ã•ã„ï¼š"
          echo "${AUTH_URL}"
          echo ""
          echo "ğŸ“Œ å¿…ãšãƒ¡ãƒ¢ï¼š code_verifierï¼ˆSTEP2ã§ä½¿ã„ã¾ã™ï¼‰"
          echo "${CODE_VERIFIER}"
          echo ""
          echo "âœ… è¨±å¯å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹æ¬„ã«è¡¨ç¤ºã•ã‚ŒãŸ https://127.0.0.1/callback?... ã®ã€URLå…¨ä½“ã€ã‚’ã‚³ãƒ”ãƒ¼ã€‚"
          echo "â¡ï¸ æ¬¡ã«ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ã‚‚ã†ä¸€åº¦å®Ÿè¡Œã—ã€"
          echo "   inputs ã® redirect_full_url ã¨ code_verifier ã‚’å…¥åŠ›ã—ã¦ Run ã—ã¦ãã ã•ã„ã€‚"

      - name: STEP2: code ã‚’ token ã«äº¤æ›
        if: ${{ inputs.redirect_full_url && inputs.code_verifier }}
        env:
          CLIENT_ID: ${{ secrets.X_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.X_CLIENT_SECRET }}
          REDIRECT_FULL: ${{ inputs.redirect_full_url }}
          CODE_VERIFIER: ${{ inputs.code_verifier }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${CLIENT_ID:-}" ] || [ -z "${CLIENT_SECRET:-}" ]; then
            echo "âŒ X_CLIENT_ID / X_CLIENT_SECRET ãŒæœªè¨­å®šã§ã™ã€‚Secrets ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi

          # URL ã‹ã‚‰ code ã‚’å–ã‚Šå‡ºã™
          CODE=$(python3 - <<'PY'
import os,urllib.parse
u=os.environ["REDIRECT_FULL"]
qs=urllib.parse.urlparse(u).query
print(urllib.parse.parse_qs(qs).get("code",[None])[0] or "")
PY
)
          if [ -z "$CODE" ]; then
            echo "âŒ code ãŒèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚å…¥åŠ›URLã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi

          REDIRECT_URI="https://127.0.0.1/callback"

          # token äº¤æ›ï¼ˆPKCE: code_verifier ã‚’ä½¿ç”¨ï¼‰
          RESP=$(curl -sS -X POST "https://api.x.com/2/oauth2/token" \
            -u "${CLIENT_ID}:${CLIENT_SECRET}" \
            -d "grant_type=authorization_code" \
            -d "client_id=${CLIENT_ID}" \
            -d "redirect_uri=${REDIRECT_URI}" \
            -d "code_verifier=${CODE_VERIFIER}" \
            -d "code=${CODE}")

          echo "[ãƒ¬ã‚¹ãƒãƒ³ã‚¹] $RESP"

          ACCESS=$(python3 - <<'PY'
import json,os; j=json.loads(os.environ["RESP"]); print(j.get("access_token",""))
PY
)
          if [ -z "$ACCESS" ]; then
            echo "âŒ access_token ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚User authentication settings ã¨ Callback URL ã‚’å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi

          echo ""
          echo "=================  å–å¾—ã—ãŸ access_token  ================="
          echo "$ACCESS"
          echo "==========================================================="
          echo ""
          echo "ğŸ‘‰ GitHub â†’ Settings â†’ Secrets â†’ Actions â†’ New repository secret"
          echo "   Name: X_BEARER_TOKEN"
          echo "   Value: ï¼ˆä¸Šã® access_token ã‚’ä¸¸ã”ã¨è²¼ã‚Šä»˜ã‘ï¼‰"

      - name: ãƒ’ãƒ³ãƒˆ
        if: ${{ !inputs.redirect_full_url }}
        run: echo "æ¬¡ã¯ Run workflow ã‚’å†å®Ÿè¡Œã—ã¦ redirect_full_url ã¨ code_verifier ã‚’å…¥åŠ›ã—ã¦ã­ï¼"
